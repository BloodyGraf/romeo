<!DOCTYPE html>
<html>
<body>
<h1>User A</h1>

<video id="localVideo" autoplay playsinline muted></video>
<video id="remoteVideo" autoplay playsinline></video>

<script type="module">
    import {
        connect,
        createLocalTracks,
    } from "https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.esm.js";

    const LIVEKIT_URL = "ws://37.252.20.26:7880";

    async function getToken(identity) {
        const res = await fetch("http://localhost:3001/token", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ identity, room: "test-room" }),
        });
        const { token } = await res.json();
        return token;
    }

    async function start() {
        const token = await getToken("userA");
        const room = await connect(LIVEKIT_URL, token, { autoSubscribe: true });

        // local tracks
        const tracks = await createLocalTracks({
            audio: true,
            video: true,
        });

        // publish tracks one-by-one
        for (const t of tracks) room.localParticipant.publishTrack(t);

        // show local video
        const localVideo = document.getElementById("localVideo");
        localVideo.srcObject = new MediaStream(
            tracks.filter(t => t.kind === "video").map(t => t.mediaStreamTrack)
        );

        // remote track
        room.on("trackSubscribed", (track, pub, participant) => {
            if (track.kind === "video") {
                const remoteVideo = document.getElementById("remoteVideo");
                remoteVideo.srcObject = new MediaStream([track.mediaStreamTrack]);
            }
        });
    }

    start();
</script>

</body>
</html>