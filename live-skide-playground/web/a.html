<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>User A</title>
    <style>
        video {
            width: 320px;
            height: 180px;
            border: 1px solid #555;
            margin-right: 8px;
            background: #000;
        }
    </style>
</head>
<body>
<h1>User A</h1>

<video id="localVideo" autoplay playsinline muted></video>
<video id="remoteVideo" autoplay playsinline></video>

<script type="module">
    import { connect, createLocalTracks } from "./livekit-client.esm.js";

    const LIVEKIT_URL = "ws://37.252.20.26:7880";

    async function getToken(identity) {
        console.log("[A] Запрашиваю токен для", identity);
        const res = await fetch("http://localhost:3001/token", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ identity, room: "test-room" }),
        });

        if (!res.ok) {
            console.error("[A] Ошибка токена", res.status);
            throw new Error("Failed to get token");
        }

        const data = await res.json();
        return data.token;
    }

    async function start() {
        try {
            const identity = "userA";
            const token = await getToken(identity);

            console.log("[A] Создаю локальные треки...");
            const tracks = await createLocalTracks({
                audio: true,
                video: true,
            });
            console.log("[A] Локальные треки:", tracks.map((t) => t.kind));

            const localVideoTrack = tracks.find((t) => t.kind === "video");
            if (localVideoTrack) {
                const localVideoEl = document.getElementById("localVideo");
                localVideoEl.srcObject = new MediaStream([
                    localVideoTrack.mediaStreamTrack,
                ]);
                console.log("[A] Локальное видео показано");
            }

            console.log("[A] Подключаюсь к комнате...");
            const room = await connect(LIVEKIT_URL, token, {
                autoSubscribe: true,
                publishDefaults: {
                    simulcast: false, // выключаем мульти-слои, нам не нужно
                },
            });
            console.log("[A] В комнате, localParticipant:", room.localParticipant.identity);

            for (const t of tracks) {
                console.log("[A] Публикую трек:", t.kind);
                await room.localParticipant.publishTrack(t);
            }
            console.log("[A] Все треки опубликованы");

            room.on("trackSubscribed", (track, pub, participant) => {
                console.log(
                    "[A] trackSubscribed от",
                    participant.identity,
                    "kind=",
                    track.kind
                );
                if (track.kind === "video") {
                    const remoteEl = document.getElementById("remoteVideo");
                    remoteEl.srcObject = new MediaStream([track.mediaStreamTrack]);
                    console.log("[A] Remote video установлен");
                }
            });

            room.on("trackUnsubscribed", (track, pub, participant) => {
                console.log(
                    "[A] trackUnsubscribed от",
                    participant.identity,
                    "kind=",
                    track.kind
                );
            });
        } catch (e) {
            console.error("[A] ОШИБКА start():", e);
        }
    }

    start();
</script>
</body>
</html>