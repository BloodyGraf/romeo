<!DOCTYPE html>
<html>
<body>
<h1>User A</h1>

<video id="localVideo" autoplay playsinline muted></video>
<video id="remoteVideo" autoplay playsinline></video>

<script type="module">
    import {
        connect,
        createLocalVideoTrack,
        createLocalAudioTrack
    } from "./livekit-client.esm.js"; // локальный sdk

    const LIVEKIT_URL = "ws://37.252.20.26:7880";

    async function getToken(identity) {
        const res = await fetch("http://localhost:3001/token", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ identity, room: "test-room" }),
        });
        return (await res.json()).token;
    }

    async function start() {
        const token = await getToken("userA");

        // Отключение simulcast — КРИТИЧЕСКО!
        const room = await connect(LIVEKIT_URL, token, {
            autoSubscribe: true,
            publishDefaults: {
                simulcast: false,
                videoSimulcastLayers: [],
            },
        });

        // создаём треки вручную
        const video = await createLocalVideoTrack();
        const audio = await createLocalAudioTrack();

        // показываем локальное видео
        document.getElementById("localVideo").srcObject =
            new MediaStream([video.mediaStreamTrack]);

        await room.localParticipant.publishTrack(video);
        await room.localParticipant.publishTrack(audio);

        room.on("trackSubscribed", (track, pub, participant) => {
            if (track.kind === "video") {
                document.getElementById("remoteVideo").srcObject =
                    new MediaStream([track.mediaStreamTrack]);
            }
        });
    }

    start();
</script>
</body>
</html>