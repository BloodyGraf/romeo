<!DOCTYPE html>
<html>
<body>
<h1>User A</h1>
<video id="local" autoplay muted playsinline></video>
<video id="remote" autoplay playsinline></video>

<script type="module">
    import {
        connect,
        createLocalVideoTrack,
        createLocalAudioTrack,
    } from "https://cdn.jsdelivr.net/npm/livekit-client/dist/livekit-client.esm.js";

    async function getToken(identity) {
        const res = await fetch("http://localhost:3001/token", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ identity, room: "test-room" }),
        });
        return (await res.json()).token;
    }

    async function start() {
        const token = await getToken("userA");

        const room = await connect("ws://localhost:7880", token);

        const videoTrack = await createLocalVideoTrack();
        const audioTrack = await createLocalAudioTrack();

        room.localParticipant.publishTrack(videoTrack);
        room.localParticipant.publishTrack(audioTrack);

        document.getElementById("local").srcObject = new MediaStream([
            videoTrack.mediaStreamTrack,
        ]);

        room.on("trackSubscribed", (track) => {
            if (track.kind === "video") {
                document.getElementById("remote").srcObject = new MediaStream([
                    track.mediaStreamTrack,
                ]);
            }
        });
    }

    start();
</script>
</body>
</html>