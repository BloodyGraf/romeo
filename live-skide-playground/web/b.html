<meta charset="UTF-8" />

<!DOCTYPE html>
<html lang="en">
<body>
<h1>User B</h1>

<video id="localVideo" autoplay playsinline muted style="width: 300px; border: 1px solid #555;"></video>
<video id="remoteVideo" autoplay playsinline style="width: 300px; border: 1px solid #555;"></video>

<script type="module">
    import {
        connect,
        createLocalTracks,
    } from "./livekit-client.esm.js"; // ЛОКАЛЬНЫЙ SDK

    const LIVEKIT_URL = "ws://37.252.20.26:7880";

    async function getToken(identity) {
        console.log("[B] Запрашиваю токен для", identity);
        const res = await fetch("http://localhost:3001/token", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ identity, room: "test-room" }),
        });

        if (!res.ok) {
            console.error("[B] Ошибка при запросе токена", res.status);
            throw new Error("Failed to get token");
        }

        const data = await res.json();
        console.log("[B] Токен получен");
        return data.token;
    }

    async function start() {
        try {
            const identity = "userB";
            const token = await getToken(identity);

            console.log("[B] Создаю локальные треки...");
            const tracks = await createLocalTracks({
                audio: true,
                video: true,
            });
            console.log("[B] Локальные треки:", tracks.map(t => t.kind));

            const localVideoTrack = tracks.find(t => t.kind === "video");
            if (localVideoTrack) {
                const localVideoEl = document.getElementById("localVideo");
                localVideoEl.srcObject = new MediaStream([localVideoTrack.mediaStreamTrack]);
                console.log("[B] Локальное видео повесил на тег");
            } else {
                console.warn("[B] В локальных треках нет видео");
            }

            console.log("[B] Подключаюсь к комнате...");
            const room = await connect(LIVEKIT_URL, token, {
                autoSubscribe: true,
                publishDefaults: {
                    simulcast: false,
                },
            });
            console.log("[B] Подключился к комнате, localParticipant:", room.localParticipant.identity);

            for (const t of tracks) {
                console.log("[B] Публикую трек:", t.kind);
                await room.localParticipant.publishTrack(t);
            }
            console.log("[B] Все треки опубликованы");

            room.on("trackSubscribed", (track, pub, participant) => {
                console.log("[B] trackSubscribed от", participant.identity, "kind=", track.kind);
                if (track.kind === "video") {
                    const remoteEl = document.getElementById("remoteVideo");
                    remoteEl.srcObject = new MediaStream([track.mediaStreamTrack]);
                    console.log("[B] Поставил remoteVideo");
                }
            });

            room.on("trackUnsubscribed", (track, pub, participant) => {
                console.log("[B] trackUnsubscribed", participant.identity, track.kind);
            });
        } catch (e) {
            console.error("[B] ОШИБКА В start():", e);
        }
    }

    start();
</script>
</body>
</html>